<%-include("../include/head.ejs", {
  title: "OnBeat - Music Guild Dashboard",
  description: "Music guild dashboard."
})%>
<%-include("../include/nav.ejs")%>

<%if(req.user) {%>
<%req.user.guilds.forEach(g => {
      if(g.id === guild.id) {
    %>

    <form id="requestMusic" class="fixed z-[1] bottom-0 flex w-full justify-center mb-3"  action="/api/guild/<%=guild.id%>/track/add" method="post">
      <input name="music" id="music" class="text-slate-900 text-center p-1 drop-shadow rounded-xl" placeholder="Search for music to play in <%=guild.name%>" autocomplete="off"></input>
    </form>
    <div class="flex flex-col justify-center justify-items-center items-center content-center text-center w-full h-[80vh] overflow-hidden" id="stopped">
      <!--<img src="" id="img-error" class="w-64"/>-->
      <p class="text-2xl">
        Nothing playing...
      </p>
    </div>
    <div id="loading" class="hidden flex flex-col justify-center items-center text-center w-full overflow-hidden h-[80vh]">
      <div role="status" class="flex flex-col space-y-8 animate-pulse md:space-y-0 md:space-x-8 md:flex md:items-center justify-center">
        <div class="flex justify-center items-center h-48 w-48 p-2 bg-gray-300 rounded-2xl sm:h-96 sm:w-96 dark:bg-gray-700">
        </div>
        <div class="w-full">
          <div class="p-2 bg-gray-200 rounded-full dark:bg-gray-700 w-48 mb-4"></div>
          <div class="p-1.5 bg-gray-200 rounded-full dark:bg-gray-700 max-w-[100px]"></div>
        </div>
        <span class="sr-only">Loading...</span>
      </div>
    </div>
    <div id="queue" class="hidden w-full overflow-hidden" x-data="{ tab: 'track' }">
      <nav class="fixed z-[3] top-16 bg-white/70 dark:bg-gray-900/70 mb-4 border-b border-gray-200 dark:border-gray-700 w-full backdrop-blur-lg">
        <ul class="flex flex-wrap -mb-px text-sm font-medium text-center">
          <li class="w-1/4"><button class="inline-block p-4 rounded-t-lg border-b-2 border-transparent transition-all w-full" x-on:click="tab = 'track'" x-bind:class="{'text-blue-700 border-blue-700 dark:border-blue-300 dark:text-blue-300':tab==='track'}">Overview</button></li>
          <li class="w-2/4"><button class="inline-block p-4 rounded-t-lg border-b-2 border-transparent transition-all w-full" x-on:click="tab = 'queue'" x-bind:class="{'text-blue-700 border-blue-700 dark:border-blue-300 dark:text-blue-300':tab==='queue'}">Queue</button></li>
          <li class="w-1/4"><button class="inline-block p-4 rounded-t-lg border-b-2 border-transparent transition-all w-full" x-on:click="tab = 'lyrics'" x-bind:class="{'text-blue-700 border-blue-700 dark:border-blue-300 dark:text-blue-300':tab==='lyrics'}">Lyrics</button></li>
        </ul>
      </nav>
      <!--<div class="m-16"></div>--->
      <div id="queueList" class="m-12" x-show="tab === 'queue'" x-transition>
        <p id="queueNone">
          The currently playing song is the only one in queue..
        </p>
        <div class="" id="queueMusic0"></div>
        <div class="" id="queueMusic1"></div>
        <div class="" id="queueMusic2"></div>
        <div class="" id="queueMusic3"></div>
        <div class="" id="queueMore4"></div>
      </div>
      <div id="track" class="flex flex-col items-center justify-center h-[80vh] w-full transition-all" x-show="tab === 'track'"
        x-transition>
        <img class="rounded-2xl flex justify-center items-center text-center w-48 p-2" src="/images/favicon.ico" id="track-image"></img>
        <p class="" id="track-name">
          Null
        </p>
        <p class="text-gray-600 dark:text-gray-400" id="track-artist">
          Null
        </p>
        <p class="hidden">
          Requested by <span id="track-userRequest">Null</span>
        </p>
        <div class="player">
          <div class="text-slate-900 dark:text-slate-100">
            <!--<p id="time">
                                                                      0:00
                                                                    </p>--->
          </div>
          <div id="player-buttons" class="mt-3 flex dark:text-white text-center">
            <button onclick="pause(this, '<%=guild.id%>', '<%=req.user.id%>')" id="play">
              <i id="icon" data-feather="pause"></i>
            </button>
            <button onclick="skip(this, '<%=guild.id%>', '<%=req.user.id%>')" id="skip">
              <i data-feather="skip-forward"></i>
            </button>
          </div>
        </div>
      </div>
      <div class="fixed w-full top-0 bg-zinc-700 rounded-full h-4 dark:bg-zinc-200">
        <div class="bg-rose-700 dark:bg-fuchsia-400 h-4 rounded-full" id="time-progress" style="width: 0%"></div>
      </div>
      <div id="lyrics" class="flex flex-col mt-12 justify-center w-full text-center transition-all" x-show="tab === 'lyrics'"
        x-transition
        >
        <p class="text-center" id="lyrics-text">

        </p>

        <p class="fixed z-[0] text-gray-500 dark:text-gray-400 text-sm bottom-0 right-0 drop-shadow mr-2">
          Lyrics provided by Genius API
        </p>
      </div>
    </div>
    <div id="toast-music" class="fixed z-[4] flex justify-center items-center top-0 m-2 bg-gray-100 text-black dark:bg-gray-700 dark:text-white text-center opacity-0 -translate-x-full transition-all duration-500 p-2">
      <p id="toast-music-text">
        {user} requested {music}
      </p>
    </div>

    <script>
     const music = {
        img: document.getElementById("track-image"),
        title: document.getElementById("track-name"),
        artist: document.getElementById("track-artist"),
        time: document.getElementById("time"),
        progress: document.getElementById("time-progress"),
        user: document.getElementById("track-userRequest")
      }
const request = document.getElementById("requestMusic");
const query = document.getElementById("music");
 const notrack = document.getElementById("stopped");
      const trackEl = document.getElementById("queue");
 $(function() {
  $("#requestMusic").submit((e) => {
    e.preventDefault()
    $.post(`/api/guild/<%=guild.id%>/track/add?user=<%=req.user.id%>&query=${query.value}`, {}, function(data, status) {
      console.log(data);
      console.log(status);
    });
    query.value=""
    // return false;
  })
 })
 setInterval(() => {
   $(function() {
    $.get(`/api/guild/<%=guild.id%>/queue`, function(data, status) {
        if (!data.track) {
          notrack.classList.remove("hidden");
          trackEl.classList.add("hidden");
          return;
        } else {
          music.img.src = data.track.thumbnail;
          music.title.textContent = data.track.title;
          music.artist.textContent = data.track.artist;
          
          data.tracks.map((track, i) => {
          console.log(i, track)
          const ione = i+1;
          if (!track) {
            document.getElementById("queueNone").classList.remove("hidden")
          }
          //$('#queueMusic' + i).html(`<p></p>`)
          document.getElementById("queueNone").classList.add("hidden")
          $('#queueMusic' + i).html(`<p>${i + 1}) ${data.tracks[i]?data.tracks[i].title: ""} - <span>${data.tracks[i]?data.tracks[i].author: ""}</span></p><br>`)
          if (ione > 4) {
            $('#queueMore4').html(`<p>And others <span>${i-3}</span> musics</p>`);
          }
          if (!data.tracks[i+1]) return $('#queueMusic' + ione).html("");
        })
          
          notrack.classList.add("hidden");
          trackEl.classList.remove("hidden");
        }
        // music.time.textContent = `${info.perc.current}`
      })
       $.get(`/api/guild/<%=guild.id%>/queue/progress`, function(data, status) {
         if (data.progress > 100) {
          music.progress.style.width = `100%`;
        } else {
          music.progress.style.width = `${data.progress}%`
        }
       })
     })
  }, 1000);
    </script>
    <%
  } else return;
    })%>
    <%} else {%>
     <div class="flex flex-col w-full h-[95vh] justify-center items-center">
              <p>
                Please login with one of these platforms to continue:
              </p>
              <br>
              <a href="/auth/callback" class="text-center flex items-center justify-center gap-x-2  bg-blue-900 text-white dark:bg-blue-100 dark:text-black p-2 rounded-xl mb-3 w-32"><i class="fa-brands fa-discord"></i>Discord</a>
            </div>
  <%}%>
  <%-include('../include/footer.ejs')%>
